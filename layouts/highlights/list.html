{{ define "main" }}

<section>
  <div>
    {{ .Content }} Please <i>click on the button below to suggest work that should be the subject of a data
      highlight</i>. You can suggest your own tool/data/research, or someone elseâ€™s, and the editorial team will get in
    touch with you as soon as possible to discuss your suggestion.</div>
</section>

<section>
  <!-- Button to suggest -->
  <div class="row">
    <div class="col my-2">
      <button type="button" class="btn btn-aqua" data-bs-toggle="modal" data-bs-target="#suggestionModal">
        Suggest a highlight
      </button>
    </div>
    <div class="col-sm col-lg-3 my-2">
      <div class="input-group">
        <span class="input-group-text"><i class="bi bi-search"></i></span>
        <input type="text" class="form-control" placeholder="Search Keywords" aria-label="Search" data-search-area="highlights_container">
      </div>
    </div>
  </div>

  
  <!-- DH suggestion form, appears when the above button is clicked  -->
  <div class="modal fade" id="suggestionModal" tabindex="-1" aria-labelledby="suggestionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form class="needs-validation" novalidate accept-charset="utf-8" id="highlights-form">
          <div class="modal-header">
            <h5 class="modal-title" id="suggestionModalLabel">Data highlight suggestion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="">
              <p>We welcome suggestions for data highlights. Highlights on the SciLifeLab Data Platform focus on openly
                shared data, open source tools, or work based on the use of open-source data/tools. You are welcome to
                suggest your own work, or someone else's, as something of potential interest for the Swedish data-driven
                life science community. The team behind the SciLifeLab Data Platform will make a decision on whether the
                work can be showcased in the data highlights section. Highlights can be written by yourself or a member
                of the Platform team. In either case, the team will work closely with you throuhgout the process.</p>
              <p>Please fill out the form below to suggest a data highlight. We will get back to you with our decision
                and further steps shortly after we receive the suggestion.</p>
            </div>
            <div class="mb-3">
              <label for="title" class="form-label fw-bold">Title of the work:*</label>
              <input type="text" class="form-control" id="title" name="title" required>
            </div>
            <div class="mb-3">
              <label for="url" class="form-label fw-bold">URL or DOI with more information:*</label>
              <input type="text" class="form-control" id="url" name="url" required>
              <div class="form-text">Enter URL starting with 'https://...' or DOI.</div>
            </div>
            <div class="mb-3">
              <label for="description" class="form-label fw-bold">Description:</label>
              <textarea class="form-control" id="description" name="description" rows="5"></textarea>
              <div class="form-text">Please describe why you think this dataset, tool, or result should be showcased as
                a data highlight on the SciLifeLab Data Platform.</div>
            </div>
            <div class="mb-3 form-check fw-bold">
              <label class="form-check-label" for="i_am_an_author">I am (one of) the author(s) of this work.</label>
              <input type="checkbox" class="form-check-input" id="i_am_an_author" name="i_am_an_author">
            </div>
            <div class="mb-3 form-check fw-bold">
              <label class="form-check-label" for="would_like_to_write_text">I would like to write the text for this
              <input type="checkbox" class="form-check-input" id="would_like_to_write_text"
                name="would_like_to_write_text">
                data highlight myself.</label>
            </div>
            <div class="mb-3">
              <label for="submitter_name" class="form-label fw-bold">Your name:</label>
              <input type="text" class="form-control" id="submitter_name" name="submitter_name">
              <div class="form-text">Enter your name if you agree to be contacted regarding this suggestion.</div>
            </div>
            <div class="mb-3">
              <label for="submitter_email" class="form-label fw-bold">Your contact email:</label>
              <input type="email" class="form-control" id="submitter_email" name="submitter_email">
              <div class="form-text">Enter your email address if you agree to be contacted regarding this suggestion.
              </div>
            </div>
            <!-- Additional fields -->
            <div class="mb-3" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" aria-hidden="true">
              <label for="website" class="form-label">Website:</label>
              <input type="text" class="form-control" id="website" name="website" tabindex="-1" autocomplete="off">
            </div>
            
            <div class="mb-3" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" aria-hidden="true">
              <label for="phone_number" class="form-label">Phone:</label>
              <input type="text" class="form-control" id="phone_number" name="phone_number" tabindex="-1" autocomplete="off">
            </div>
            
            <div class="mb-3" style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" aria-hidden="true">
              <label for="company" class="form-label">Company:</label>
              <input type="text" class="form-control" id="company" name="company" tabindex="-1" autocomplete="off">
            </div>
            
            <!-- Session tracking for anti-spam -->
            <input type="hidden" name="session_id" id="session_id" value="">
            <input type="hidden" name="session_duration" id="session_duration" value="">
            
            <!-- Form metadata -->
            <input type="url" id="originUrl" name="originUrl" value="" hidden aria-label="form-origin-url" />
            <input type="hidden" name="origin" value="data_highlight_suggestion" aria-label="form-name" />
            
            <!-- Commented out reCAPTCHA - can be re-enabled for production if needed -->
            <!-- <div class="g-recaptcha" data-sitekey="6LdPd50fAAAAAJ_dVMXFJjzOTh7XZeAI-ej82GPv"></div> -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-aqua" id="highlights-submit-btn" onclick="submitHighlightsForm()">Submit</button>
          </div>
          
          <!-- Success message -->
          <div class="alert alert-success mt-3" id="highlights-success-message" style="display: none;">
            <h4 class="alert-heading">Thank you!</h4>
            <p id="highlights-success-message-text">Your data highlight suggestion has been submitted successfully. We'll review it and get back to you soon.</p>
          </div>
          
          <!-- Error message -->
          <div class="alert alert-danger mt-3" id="highlights-error-message" style="display: none;">
            <h4 class="alert-heading">Submission failed</h4>
            <p id="highlights-error-message-text">There was an issue with your submission. Please try again.</p>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<section>
  <div id="highlights_container">
    <div class="row g-3">
      {{ range .RegularPages }}
      {{ $search_tags := slice .Title }}
      {{ range (.GetTerms "tags") }}
        {{ $search_tags = $search_tags | append .LinkTitle }}
      {{ end }}
      {{ with .Params.search_tags }}
        {{ $search_tags = $search_tags | append . }}
      {{ end }}
      <div class="col-md-4 data-highlight" data-search-tags="{{ delimit $search_tags ":" | lower }}">
        <div class="bg-highlight p-3">
          <div>
            <a href="{{ .Page.RelPermalink }}">
              <img class="img-fluid rounded-top" src="{{ .Params.banner }}" alt="{{ if (isset .Params "banner_alt") }} {{ .Params.banner_alt }} {{ else }} {{.Title }} {{ end }}">
            </a>
          </div>
          <div class="px-2 my-1 text-muted">
            {{ .Date | time.Format ":date_long" }}
          </div>
          <div class="px-2 mb-2">
            <h5><a href="{{ .Page.RelPermalink }}">{{ .Title }}</a></h5>
          </div>
          <div class="px-2 mb-2">{{ .Summary }}</div>
          <div class="px-2 mb-2">{{ range (.GetTerms "tags") }}
            <span class="badge highlight-tag"><a href="{{ .RelPermalink }}">{{ .LinkTitle }}</a></span>
            {{ end }}</div>
        </div>
      </div>
      {{ end }}
    </div>
    <div id="no-filtered-dh" class="pt-2" style="display:none;">
      <p class="text-center">No data highlight have the given keyword, please try to use another.</p>
    </div>
  </div>
</section>

<script>
  // Initialize session tracking for anti-spam
  var sessionStartTime = Date.now();
  var sessionId = 'highlights_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
  
  // Set session data
  document.addEventListener("DOMContentLoaded", function (event) {
    document.getElementById('session_id').value = sessionId;
    document.getElementById('originUrl').value = location.href;
  });
  
  // Form validation functions
  function validateHighlightsForm() {
    var form = document.getElementById('highlights-form');
    var isValid = true;
    
    // Check required fields
    var requiredFields = ['title', 'url'];
    
    requiredFields.forEach(function(fieldName) {
      var field = document.getElementById(fieldName);
      if (!field.value.trim()) {
        isValid = false;
        field.classList.add('is-invalid');
      } else {
        field.classList.remove('is-invalid');
      }
    });
    
    // Validate email if provided
    var emailField = document.getElementById('submitter_email');
    if (emailField.value.trim() && !emailField.value.match(/^[^\s@]+@[^\s@]+\.[^\s@]+$/)) {
      isValid = false;
      emailField.classList.add('is-invalid');
    } else {
      emailField.classList.remove('is-invalid');
    }
    
    return isValid;
  }
  
  function validateHighlightsSubmission() {
    var sessionDuration = (Date.now() - sessionStartTime) / 1000;
    
    // Check timing (5 seconds minimum, 1 hour maximum)
    if (sessionDuration < 5 || sessionDuration > 3600) {
      return false;
    }
    
    // Check honeypot fields
    var honeypotFields = ['website', 'phone_number', 'company'];
    for (var i = 0; i < honeypotFields.length; i++) {
      if (document.getElementById(honeypotFields[i]).value.trim() !== '') {
        return false;
      }
    }
    
    return true;
  }
  
  function showHighlightsSuccess(message) {
    document.getElementById('highlights-success-message-text').textContent = message;
    document.getElementById('highlights-success-message').style.display = 'block';
    document.getElementById('highlights-error-message').style.display = 'none';
    
    // Reset form
    document.getElementById('highlights-form').reset();
    
    // Hide modal after a delay
    setTimeout(function() {
      $('#suggestionModal').modal('hide');
    }, 2000);
  }
  
  function showHighlightsError(message) {
    document.getElementById('highlights-error-message-text').textContent = message;
    document.getElementById('highlights-error-message').style.display = 'block';
    document.getElementById('highlights-success-message').style.display = 'none';
  }
  
  function submitHighlightsForm() {
    // Validate form
    if (!validateHighlightsForm()) {
      showHighlightsError('Please fill out all required fields correctly.');
      return;
    }
    
    // Validate submission timing and honeypots
    if (!validateHighlightsSubmission()) {
      showHighlightsError('Form submission failed validation. Please try again.');
      return;
    }
    
    // reCAPTCHA validation - commented out to test anti-spam
    /*
    var recaptcha = $("#g-recaptcha-response").val();
    if (recaptcha === "") {
      showHighlightsError("Please tick 'I'm not a robot' above the 'Submit' button.");
      return;
    }
    */
    
    // Set session duration
    document.getElementById('session_duration').value = (Date.now() - sessionStartTime) / 1000;
    
    // Show loading state
    var submitBtn = document.getElementById('highlights-submit-btn');
    var originalText = submitBtn.textContent;
    submitBtn.textContent = 'Submitting...';
    submitBtn.disabled = true;
    
    // Collect form data
    var formData = new FormData(document.getElementById('highlights-form'));
    
    // reCAPTCHA data - commented out to test anti-spam
    /*
    var recaptchaResponse = $("#g-recaptcha-response").val();
    if (recaptchaResponse) {
      formData.append('g-recaptcha-response', recaptchaResponse);
    }
    */
    
    // Submit to Google Apps Script
    fetch('https://script.google.com/macros/s/AKfycbzDm3HImX8rx052Ooe888T702iuAYNosV4zO3mgSgucQ1IKCI2hhP_EMhFI82lMqDDT/exec', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showHighlightsSuccess(data.message);
      } else {
        showHighlightsError(data.message);
      }
    })
    .catch(error => {
      showHighlightsError('Network error. Please check your connection and try again.');
    })
    .finally(() => {
      // Reset button
      submitBtn.textContent = originalText;
      submitBtn.disabled = false;
    });
  }
  
  // Function to filter the service based on search text
  $("input[type=text]").on("input", function(){
    
    // Get the text entered and service category 
    var searchText = $(this).val().toLowerCase();
    var searchArea = this.getAttribute('data-search-area');
    
    // Hide all services before filtering
    $(`div#highlights_container div.data-highlight`).hide();
    $(`div#no-filtered-dh`).hide();
    
    // If text empty show all services
    if (searchText == ''){
      $(`div#highlights_container div.data-highlight`).show();
    } else {
      $(`div#highlights_container div[data-search-tags*='${searchText}']`).show();
      
      // Display a message if no services available for given keyword
      var visible_services = $(`div#highlights_container div.data-highlight`).filter(":visible");
      if (!visible_services.length) {
        $(`div#no-filtered-dh`).show();
      }
    }
  });
  
  // reCAPTCHA aria-label setup - commented out to test anti-spam
  /*
  window.addEventListener("load", function () {
    $('textarea#g-recaptcha-response').attr('aria-label', "The recaptcha response will appear here");
  });
  */
</script>

{{ end }}
